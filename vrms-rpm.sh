#!/bin/bash
#
# vrms-rpm - list non-free packages on an rpm-based Linux distribution
# Copyright (C) 2017 Artur "suve" Iwicki
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License, version 3,
# as published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program (LICENCE.txt). If not, see <http://www.gnu.org/licenses/>.
#


# List based on https://fedoraproject.org/wiki/Licensing:Main#Good_Licenses
good_licences=(
	"AAL"
	"Abstyles"
	"Adobe"
	"ADSL"
	"AFL"
	"Afmparse"
	"AGPLv1"
	"AGPLv3"
	"AGPLv3+"
	"AMDPLPA"
	"AML"
	"AMPAS BSD"
	"AMS"
	"APAFML"
	"App-s2p"
	"APSL 2.0"
	"ARL"
	"Arphic"
	"Artistic 2.0"
	"Artistic clarified"
	"ASL 1.0"
	"ASL 1.1"
	"ASL 2.0"
	"Baekmuk"
	"Bahyph"
	"Barr"
	"Beerware"
	"BeOpen"
	"Bibtex"
	"Bitstream Vera"
	"BitTorrent"
	"Boost"
	"Borceux"
	"BSD"
	"CATOSL"
	"CC0"
	"CC-BY"
	"CC-BY-SA"
	"CDDL"
	"CDL"
	"CeCILL"
	"CeCILL-B"
	"CeCILL-C"
	"Charter"
	"CNRI"
	"Condor"
	"Copyright only"
	"CPAL"
	"CPL"
	"CRC32"
	"Crossword"
	"Crystal Stacker"
	"Cube"
	"diffmark"
	"DMIT"
	"DOC"
	"Dotseqn"
	"DoubleStroke"
	"DSDP"
	"DSL"
	"dvipdfm"
	"DWPL"
	"ec"
	"ECL 1.0"
	"ECL 2.0"
	"eCos"
	"EFL 2.0"
	"eGenix"
	"Elvish"
	"Entessa"
	"EPICS"
	"EPL"
	"ERPL"
	"EU Datagrid"
	"EUPL 1.1"
	"Eurosym"
	"Fair"
	"FBSDDL"
	"Free Art"
	"FSFUL"
	"FSFULLR"
	"FTL"
	"GeoGratis"
	"GFDL"
	"Giftware"
	"GL2PS"
	"Glide"
	"Glulxe"
	"gnuplot"
	"GPL"
	"GPL+"
	"GPLv1"
	"GPLv2"
	"GPLv2+"
	"GPLv3"
	"GPLv3+"
	"Green OpenMusic"
	"HaskellReport"
	"Hershey"
	"HSRL"
	"IBM"
	"IEEE"
	"IJG"
	"ImageMagick"
	"iMatix"
	"Imlib2"
	"Intel ACPI"
	"Interbase"
	"IPA"
	"ISC"
	"Jabber"
	"JasPer"
	"JPython"
	"Julius"
	"Knuth"
	"Latex2e"
	"LBNL BSD"
	"LDPL"
	"Leptonica"
	"LGPLv2"
	"LGPLv2+"
	"LGPLv3"
	"LGPLv3+"
	"Lhcyr"
	"Liberation"
	"libtiff"
	"LLGPL"
	"Logica"
	"LOSLA"
	"LPL"
	"LPPL"
	"Lucida"
	"MakeIndex"
	"mecab-ipadic"
	"MgOpen"
	"midnight"
	"MirOS"
	"MIT"
	"MITNFA"
	"mod_macro"
	"Motosoto"
	"mplus"
	"MPLv1.0"
	"MPLv1.1"
	"MPLv2.0"
	"MS-PL"
	"MS-RL"
	"MTLL"
	"Mup"
	"Naumen"
	"NCSA"
	"NetCDF"
	"Netscape"
	"Newmat"
	"Newsletr"
	"NGPL"
	"NLPL"
	"Nmap"
	"Nokia"
	"NOSL"
	"Noweb"
	"OAL"
	"OFSFDL"
	"OGL"
	"OML"
	"OpenLDAP"
	"OpenPBS"
	"Open Publication"
	"OpenSSL"
	"OReilly"
	"OSL 1.0"
	"OSL 1.1"
	"OSL 2.0"
	"OSL 2.1"
	"OSL 3.0"
	"Par"
	"Phorum"
	"PHP"
	"PlainTeX"
	"Plexus"
	"PostgreSQL"
	"psfrag"
	"psutils"
	"PTFL"
	"Public domain"
	"Public Domain"
	"Public use"
	"Public Use"
	"Punknova"
	"Python"
	"Qhull"
	"QPL"
	"Rdisc"
	"REX"
	"RiceBSD"
	"Romio"
	"RPSL"
	"Rsfs"
	"Ruby"
	"Saxpath"
	"SCEA"
	"SCRIP"
	"Sendmail"
	"Sequence"
	"SISSL"
	"Sleepycat"
	"SLIB"
	"SNIA"
	"softSurfer"
	"SPL"
	"STIX"
	"STMPL"
	"SWL"
	"TCGL"
	"TCL"
	"Teeworlds"
	"TGPPL"
	"Threeparttable"
	"TMate"
	"Tolua"
	"TORQUEv1.1"
	"TOSL"
	"TPDL"
	"TPL"
	"TTWL"
	"UCAR"
	"UCD"
	"Unicode"
	"Unlicense"
	"Utopia"
	"Verbatim"
	"Vim"
	"VNLSL"
	"VOSTROM"
	"VSL"
	"W3C"
	"Wadalab"
	"Webmin"
	"Wsuipa"
	"WTFPL"
	"wxWidgets"
	"XANO"
	"Xerox"
	"xinetd"
	"xpp"
	"XSkat"
	"YPLv1.1"
	"Zed"
	"Zend"
	"zlib"
	"ZPLv1.0"
	"ZPLv2.0"
	"ZPLv2.1"
)

good_licences_argstring=""
for ((l=0; l<${#good_licences[@]}; ++l)); do
	good_licences_argstring="$good_licences_argstring	--regexp	${good_licences[$l]}"
done

function classify_package() {
	echo "$2" | grep --quiet --fixed-strings --word-regexp $good_licences_argstring
	
	if [[ "$?" -eq 0 ]]; then
		free[${#free[@]}]=$1
	else
		nonfree[${#nonfree[@]}]=$1
	fi
}

# For splitting the package list line-by-line
IFS="
"

packages=`rpm --all --query --queryformat '%{NAME}:%{LICENSE}\n'`
packages=($packages)

free=()
nonfree=()

# Will be used later when expanding $good_licences_argstring to separate args
IFS="	"

for ((i=0; i< ${#packages[@]}; ++i)); do
	line=${packages[$i]}
	name=${line%%:*}
	licence=${line##*:}
	
	classify_package "$name" "$licence"
done

echo "${#free[@]} free packages"
echo "${#nonfree[@]} nonfree packages"
